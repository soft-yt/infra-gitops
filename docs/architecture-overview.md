# Архитектурный обзор

**Статус документа:** Draft · **Аудитория:** платформенная команда · **Источник:** `plan.md`

## 1. Цели платформы
- Единый поток: генерация сервисов Go + React → сборка контейнеров → доставка в мультиоблачные и on-prem кластеры Kubernetes.
- GitHub выступает управляющим контуром: шаблоны, CI/CD и GitOps-репозитории живут в `github.com/soft-yt/`.
- Argo CD через ApplicationSet поддерживает желаемое состояние во всех кластерах; секреты остаются зашифрованными или подтягиваются во время выполнения.

## 2. Общий поток
```
Разработчик → репозиторий из шаблона → GitHub Actions CI → образы в GHCR
→ репозиторий infra-gitops → Argo CD ApplicationSet → целевые кластеры
```

- Сервисы создаются через шаблон Backstage или CLI и пушатся как репозитории на основе `app-base-go-react`.
- CI собирает и публикует образы backend/frontend в GHCR, после чего обновляет GitOps-репозиторий новыми тегами.
- Argo CD синхронизирует манифесты в кластерах (YC, Sber, VK, on-prem) через генератор ApplicationSet по каждому overlay.

## 3. Ключевые компоненты
### Шаблон сервиса (`app-base-go-react`)
- Монорепозиторий с Go backend (`backend/`) и React frontend (`frontend/`), каждый собирается в Docker-образ.
- Общее деплой-представление лежит в `deploy/kustomize/apps/webapp/`; overlays добавляют окруженческие настройки.

### CI/CD (`.github/workflows/ci.yml`)
- Два job (`backend`, `frontend`) собирают и пушат Docker-образы через Buildx в `ghcr.io/soft-yt/`.
- После сборки автоматизация (TBD) обновляет GitOps-репозиторий, подставляя новые теги образов.

### GitOps (`infra-gitops`)
- `clusters/` содержит конфигурацию для каждого кластера; `apps/webapp/` хранит Kustomize base + overlays.
- ApplicationSet именует приложения `webapp-<overlay>` и направляет их в namespace `default`, включая автоматический sync (prune + selfHeal).

### Инфраструктура и наблюдаемость
- Кластеры Kubernetes в YC/Sber/VK и on-prem; в каждом установлен Argo CD.
- Секреты: в Git шифруются через SOPS (age), во время выполнения подгружаются из Vault; авторизация GitHub Actions через OIDC.
- Наблюдаемость: Prometheus, Grafana, Loki, Tempo; по необходимости сервис-меш (Istio/Linkerd), а также ExternalDNS и cert-manager.

## 4. Ответственности
- **Платформенная команда:** поддерживает шаблоны, CI-конвейеры, GitOps-автоматизацию и общие инфраструктурные модули.
- **Команды сервисов:** ведут свои репозитории, соблюдают правила шаблона, обновляют overlays через GitOps.
- **Команда безопасности:** управляет политиками Vault, ключами SOPS и правилами подписи образов (Cosign + Argo CD ImagePolicy).

## 5. Открытые вопросы
- Финализировать механику обновления GitOps-репозитория (GitHub Actions vs. отдельный бот).
- Определить стратегию ingress по умолчанию для окружений (Istio Gateway или Traefik).
- Закрепить ответственность за развёртывание и поддержку стека наблюдаемости (платформа или SRE).
