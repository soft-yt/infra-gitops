# Инфраструктура и платформенные сервисы

**Статус документа:** Draft · **Аудитория:** платформенные инженеры и SRE.

## 1. Кластеры Kubernetes
- Целевые среды: Yandex Cloud, SberCloud, VK Cloud, on-prem (bare metal или vSphere).
- На каждом кластере развернуты:
  - Argo CD (namespaced), доступ ограничен через RBAC.
  - Стек наблюдаемости (Prometheus, Grafana, Loki, Tempo) через Helm.
  - Опциональный сервис-меш (Istio Gateway или Linkerd) для управления трафиком.

## 2. Сеть и маршрутизация
- ExternalDNS управляет DNS-записями по окружениям (пример: `dev.localhost`, `prod.company.ru`).
- TLS выдаётся через cert-manager: Let’s Encrypt в облаке, кастомный CA on-prem.
- Стратегия ingress определяется overlay (Istio Gateway против Traefik).

## 3. Управление секретами
- **SOPS (age):** шифрует GitOps-манифесты в `infra-gitops` (`*.enc.yaml`).
- **Vault:** выдаёт рантайм-секреты через Kubernetes auth или CSI driver; путь монтирования описывать в сервисных доках.
- Ключи шифрования хранить отдельно (KMS или аппаратный модуль), менять раз в квартал.

## 4. Безопасность образов
- Конвейер сборки подписывает образы Cosign (`cosign sign ghcr.io/soft-yt/<image>`).
- Argo CD ImagePolicy проверяет подписи перед синхронизацией; неподписанные образы блокируются.
- Формировать SBOM (Syft/Grype) и публиковать в реестр для отслеживания зависимостей.

## 5. Наблюдаемость
- Prometheus снимает метрики backend/frontend; экспонировать `/metrics` в Go-сервисе, интегрировать браузерные метрики для фронтенда.
- Grafana дашборды версионировать в `docs/assets/grafana/` (JSON экспорт, ревью обязательно).
- Loki + Tempo собирают логи и трейсы; использовать OpenTelemetry SDK в коде.

## 6. Автоматизация платформы
- Внедрить Terraform/Crossplane для кластеров, DNS, реестров.
- Автоматизировать онбординг кластеров (регистрация в Argo CD, базовые манифесты).
- Стандартизировать backup/restore для Stateful-компонентов (Vault, Prometheus, Grafana).

## 7. Открытые вопросы
- Как делится ответственность между infra и app командами за mesh и наблюдаемость.
- Нужен ли централизованный policy engine (OPA/Gatekeeper) для ограничений по ресурсам и реестрам.
- Требования к мониторингу затрат и бюджетированию по каждому облаку.
